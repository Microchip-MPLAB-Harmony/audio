<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Frameset//EN">
<html>
<head>
<title>usb_speaker</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="Doc-O-Matic" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <link rel="STYLESHEET" href="default.css" type="text/css" />

<script type="text/javascript" src="scripts.js"></script>
</head>
<body class="Element700" onload="onBodyLoadEx('frames.html', 'topic', '00139.html');" onmousedown="onBodyMouseDown();">

<!-- Begin Popups -->

<!-- End Popups -->

<!-- Begin Page Header -->
<div class="Element710" id="areafixed">
<div class="Element94">
<a href="00152.html" target="topic">Audio Demonstrations</a> &gt; <a href="00129.html" target="topic">Demonstrations</a> &gt; <a href="00139.html" target="topic">usb_speaker</a></div>
<div class="Element92">
<table width="100%" cellspacing="0" cellpadding="0">
<tr><td width="25%">
<div class="Element1">
MPLAB Harmony Audio Help</div>
</td><td width="25%">
<div class="Element2">
<a href="contents.html" target="tocidx">Contents</a> | <a href="00158.html" target="topic">Home</a></div>
</td><td width="25%">
<div class="Element90">
<a href="00138.html" target="topic">Previous</a> | <a href="00129.html" target="topic">Up</a> | <a href="00144.html" target="topic">Next</a></div>
</td><td width="25%">
<div class="Element96">
<a href="mailto:docerrors@microchip.com&subject=MPLAB Harmony Documentation Feedback (Topic ID: APPS AUDIO usb_speaker Topic Title: usb_speaker)&body=Thank you for your feedback! Please include a description of your feedback, and indicate whether you are reporting an an error in the documentation or an enhancement.">Documentation Feedback</a><br> <a href="http://support.microchip.com" target="_blank">Microchip Support</a></div>
</td></tr></table><div class="Element5">
usb_speaker</div>
</div>
</div>

<!-- End Page Header -->

<!-- Begin Client Area -->
<div class="Element720" id="areascroll">
<div class="Element721">

<!-- Begin Page Content -->
<a name="PageContent"></a><div class="Element58">
<a name="4465736372697074696F6E"></a><div class="Element11">
<div class="Element10">
<p class="Element10">
This demonstration application configures the development board to implement a USB Speaker device configured to run at 48 kHz sampling rate at 16 bit per sample.&nbsp;</p>
<p class="Element10">
The USB Device driver in Full Speed mode will interface to a USB Host (such as a personal computer) via the USB Device Stack using the V1.0 Audio Function Driver. The embedded system will enumerate with a USB audio device endpoint and enable the host system to input audio from the USB port using a standard USB Full-Speed implementation. The embedded system will stream USB playback audio to the Codec. The Codec Driver sets up the audio interface, timing, DMA channels and buffer queue to enable a continuous audio stream. The digital audio is transmitted to the codec through an I2S data module for playback through a headphone jack.&nbsp;</p>
<p class="Element10">
&nbsp;</p><div class="Element15">
Architecture</div>
<p class="Element10">
The application runs on two target boards, as follows:&nbsp;</p>
<p class="Element10">
1. SAM E70 Xplained Ultra Board</p>
<ul class="Element630">
<li class="Element600">Processor runs @ 300 MHz</li>
<li class="Element600">One push button (SW)</li>
<li class="Element600">Two LEDs (amber LED1 and green LED2). Only LED 1 can be used for a USB Device application, due to requiring VBUS sense to be selected rather than LED2.</li>
<li class="Element600">WM8904 Codec Daughter Board mounted on a X32 socket (configured as I2SC1 slave)</li>
<li class="Element600">USB Device interface</li>
</ul><div class="Element63">
<div class="TableDiv">
<table cellspacing="0" class="Table0">
<tr>
<td class="Element67" valign="top" width="10%" style="border:none;">
<div class="Element68">
<img src="Note icon.png" border="0" alt="" title=""> <strong>Note:</strong>&nbsp;</div></td><td class="Element67" valign="top" width="90%" style="border:none;">
<div class="Element68">
The SAM E70 Xplained Ultra board does not include the WM8904 Audio Codec daughterboard, which is sold separately on microchipDIRECT as part number AC328904.&nbsp;</div></td></tr></table></div></div>
<p class="Element10">
2. PIC32 MZ EF Curiosity 2</p>
<ul class="Element630">
<li class="Element600">Processor runs @ 200 MHz</li>
<li class="Element600">4 push buttons (SW1-SW4)</li>
<li class="Element600">3 LEDs (all red LED1-LED3) and RGB LED (LED4).</li>
<li class="Element600">AK4954 Codec Daughter Board mounted on X32 socket</li>
<li class="Element600">USB Device interface</li>
</ul><div class="Element63">
<div class="TableDiv">
<table cellspacing="0" class="Table0">
<tr>
<td class="Element67" valign="top" width="10%" style="border:none;">
<div class="Element68">
<img src="Note icon.png" border="0" alt="" title=""> <strong>Note:</strong>&nbsp;</div></td><td class="Element67" valign="top" width="90%" style="border:none;">
<div class="Element68">
The PIC32 MZ EF Curiosity 2 does not include the AK4954 Audio Codec daughterboard, which is sold separately on microchipDIRECT as part number AC324954.&nbsp;</div></td></tr></table></div></div>
<p class="Element10">
The usb_speaker_basic application uses the MPLAB Harmony Configurator to setup the USB Audio Device, codec, and other items in order to play back the USB audio through the WM8904 Codec Module.&nbsp;</p>
<p class="Element10">
A USB Host system is connected to the micro-mini USB device connector. The application detects the cable connection, which can also supply device power; recognizes the type of connection (Full Speed); enumerates its functions with the host, isochronous audio streaming playback through device. Audio stream data is buffered in 1 ms frames for playback using the WM8904 Codec daughter board. Audio is heard through the Headphone jack (HP OUT).&nbsp;</p>
<p class="Element10">
The following figure shows the basic architecture for the demonstration. </p><p class="Element10" style="text-align: center;">
<img src="usb speaker block diagram.png" border="0" alt="" title="">&nbsp;</p>
<p class="Element10" style="text-align: center;">
<i>Figure 1. Architecture Block Diagram</i>&nbsp;</p><div class="Element15">
Demonstration Features</div>

<ul class="Element630">
<li class="Element600">Audio playback using an WM8904 codec daughterboard on the SAM E70 xPlained Ultra (E70XULT) board.</li>
<li class="Element600">Audio playback using a AK4954 codec daughterboard on the PIC32 MZ EF Curiousity 2 (MZEFC2)</li>
<li class="Element600">USB connection to a host system using the USB Library Device Stack for a USB Speaker device using E70XULT and MZEFC2 boards</li>
<li class="Element600">E70XULT and MZEFC2 board button processing for volume/mute control</li>
<li class="Element600">USB Attach/Detach and mute status using an LED on E70XULT and MZEFC2 boards</li>
<li class="Element600">Utilization of the of SAM E70 I2S peripherals, E70 SSC (as slave) and I2SC (as master), on E70XULT board</li>
<li class="Element600">Utilization of the PIC32 I2S peripheral (as master) on the MZEFC2 board</li>
</ul><p class="Element10">
Note that all the calls to the WM8904 and AK4954 codec drivers use the form DRV_CODEC_xxx rather than DRV_WM8904_xxx. or DRV_AK4954_xxx This is to make the code more generic, such that another codec could be substituted for another without having to make changes to the application code except for the location of the driver’s public header file.&nbsp;</p>
<p class="Element10">
&nbsp;</p><div class="Element15">
Tools Setup Differences</div>
<p class="Element10">
<strong>Harmony Configuration</strong>&nbsp;</p>
<p class="Element10">
The usb_speaker demonstration uses multiples projects for multiple hardware configurations. MPLAB-X Harmony 3 projects only have one associated configuration. When each Harmony 3 project is created the MPLAB-X Harmony Configurator (MHC) code generation is guided by the processor that is selected.&nbsp;</p>
<p class="Element10">
Start MHC for the project in order to add the application code components. Both projects of the usb_speaker application use the USB Audio stack components. These can be added by selecting the Libraries/USB/Device Stack/Audio Function Driver component template under the MHC Available Components list, as shown below. </p><p class="Element10" style="text-align: center;">
<img src="usb speaker bb audio function driver.png" border="0" alt="" title=""></p><p class="Element10">
Answer yes to all questions. This loads the USB High Speed Driver, the USB Device Layer and Audio Function Driver components.&nbsp;</p>
<p class="Element10">
The Codec component to be used depends on the hardware and peripheral configuration. This is described in the following two sections.&nbsp;</p>
<p class="Element10">
The MHC Project Graph for usb_speaker_basic is shown below for the E70XULT board. </p><p class="Element10" style="text-align: center;">
<img src="APPS AUDIO usb_speaker project graph.png" border="0" alt="" title="">&nbsp;</p>
<p class="Element10" style="text-align: center;">
<i>Figure 2. USB Speaker Basic MHC Project Graph for the SAM E70 Xplained Ultra Board</i>&nbsp;</p><p class="Element10">
Each block provides configuration parameters to generate the application framework code. This includes all the needed drivers, middleware, libraries. The generated framework code is placed under the firmware/src/config directory for this usb_speaker application (usb_speaker_basic_sam_e70_xult_wm8904_usb). The usb_speaker_basic application code is located in the firmware/src directory app.c and app.h files, which utilize the framework drivers, middleware and library APIs located in definitions.h (as generated by the configurator).&nbsp;</p>
<p class="Element10">
A configuration utilizing the I2SC1 peripheral as a slave is used to replace the SSC as a master in the above diagram. Also, a configuration that adds the FreeRTOS block to the above project is also given.&nbsp;</p>
<p class="Element10">
&nbsp;</p>
<p class="Element10">
<strong>PIC32 MZ EF Curiosity 2 and the AK4965 Daughter Board Configuration</strong>&nbsp;</p>
<p class="Element10">
The MZEFC2 board configuration in similar to the prior E70XULT board configuration, but replaces the WM8904 with an AK4954 Codec, which uses a different I2S peripheral driver.&nbsp;</p>
<p class="Element10">
In the MHC, under Available Components select the BSP PIC32 MZ EF Curiosity 2.0. Under Audio&gt;Templates, double-click on AK4954 Codec Template (shown below). Answer Yes to all questions except for the one regarding FreeRTOS; answer No to that one. This loads the AK4954 Codec component along with associated I2C, I2S and timer driver components. </p><p class="Element10" style="text-align: center;">
<img src="usb speaker bb ak4954 template.png" border="0" alt="" title=""></p><p class="Element10">
The project configuration should now look something like this: </p><p class="Element10" style="text-align: center;">
<img src="usb speaker bb pic32mz project graph.png" border="0" alt="" title="">&nbsp;</p>
<p class="Element10" style="text-align: center;">
<i>Figure 3. USB Speaker Project Graph for the PIC32 MZ EF Curiosity 2 Board</i></p><p class="Element10">
&nbsp;</p>
<div class="Element15">
Harmony Code Configuration Options</div>
<p class="Element10">
Each block in the MHC Project Graph may need to be configured through parameters for the specific application. These parameters are accessed by selecting the block with the mouse, and appear in the Configuration Options window, where they can be edited. The next section describes the configuration of the USB, Math, and Codec component blocks for the USB Speaker with “Bass Boost” application.&nbsp;</p>
<p class="Element10">
USB Configuration&nbsp;</p>
<p class="Element10">
The application uses USB Library as a &quot;Device&quot; stack, which will connect to a &quot;Host&quot;. The USB High Speed Driver is set to “Full Speed”, V1.0 interface (not “High Speed”, V2.0 Interface): </p><p class="Element10" style="text-align: center;">
<img src="APPS AUDIO usb_speaker full speed.png" border="0" alt="" title=""></p><p class="Element10">
The USB Device Layer is configured by selecting Product ID Selection as “usb_speaker_demo” with an endpoint buffer size of 64 (bytes). The Product String Selection is changed to “Harmony USB Speaker w/Bass Boost Example”. This information will be used to generate the fullSpeedConfigurationDescriptor array variable structure (located in initialization.c under the config folder) that defines the enumeration of device functions with the USB Host. This structure defines the connection to the host at 48 kHz with 16 bit stereo channel data. </p><p class="Element10" style="text-align: center;">
<img src="APPS AUDIO usb_speaker endpoints.png" border="0" alt="" title=""></p><p class="Element10">
The Audio Function Driver is configured with an Audio Read Queue that matches that of the codec driver write queue for this Audio V1.0 USB Speaker interface.&nbsp;</p>
<p class="Element10">
A playback packet queue of length 64 is set with the Audio Read Queue Size configuration, which should match the Audio Write Queue Size of the WM8904/I2S. The Audio Write Queue Size is unimportant. The The maximum USB packets size is set to 48 * 2 channels/sample * 2 bytes/channel= 192 bytes, which gives a 1ms stereo sample packet size at 48Khz (the standard data frame length at this rate), thus the buffer size needs to be of the same size. </p><p class="Element10" style="text-align: center;">
<img src="APPS AUDIO usb_speaker audio function.png" border="0" alt="" title=""></p><p class="Element10">
&nbsp;</p>
<div class="Element15">
The WM8904 Codec</div>
<p class="Element10">
Using the SAM E70 Xplained Ultra board and the WM8904 Audio Codec Daughter Board:&nbsp;</p>
<p class="Element10">
The WM8904 codec uses a TWIHS (I2C) interface for configuration and control register setting and either a SSC for audio data or I2SC I2S interface. The default settings are used as shown below for SSC:&nbsp;</p>
<p class="Element10">
&nbsp;</p><p class="Element10" style="text-align: center;">
<img src="APPS AUDIO usb_speaker wm8904.png" border="0" alt="" title="">&nbsp;</p><p class="Element10">
When the I2SC1 driver is used for DRV_I2S_0 the usage mode changes to “Slave”&nbsp;</p>
<p class="Element10">
The I2S configuration uses a Transfer queue size of 64, matching that that of the USB Read Queue: </p><p class="Element10" style="text-align: center;">
<img src="APPS AUDIO usb_speaker queue size.png" border="0" alt="" title=""></p><p class="Element10">
The I2SC1 automatically replaces the “PLIB Used” when it is connected to the I2S block in place of the SSC.</p><div class="Element15">
Pin Manager</div>
<p class="Element10">
The buttons, LED, Switch, I2S and I2C interfaces using GPIO pins via the Microchip Harmony Configurator (MHC) Pin Manager, as follows for the SSC: </p><div class="Element63">
<div class="TableDiv">
<table cellspacing="0" class="Table2">
<tr>
<td class="Element65" valign="top" width="33%">
<div class="Element66">
NAME&nbsp;</div></td><td class="Element65" valign="top" width="16%">
<div class="Element66">
PORT&nbsp;</div></td><td class="Element65" valign="top" width="10%">
<div class="Element66">
E70 PIN&nbsp;</div></td><td class="Element65" valign="top" width="40%">
<div class="Element66">
Notes&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="33%">
<div class="Element68">
SSC_TK&nbsp;</div></td><td class="Element67" valign="top" width="16%">
<div class="Element68">
PB01&nbsp;</div></td><td class="Element67" valign="top" width="10%">
<div class="Element68">
20&nbsp;</div></td><td class="Element67" valign="top" width="40%">
<div class="Element68">
I2S BCLK&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="33%">
<div class="Element68">
SSC_TF&nbsp;</div></td><td class="Element67" valign="top" width="16%">
<div class="Element68">
PB00&nbsp;</div></td><td class="Element67" valign="top" width="10%">
<div class="Element68">
21&nbsp;</div></td><td class="Element67" valign="top" width="40%">
<div class="Element68">
I2S LRCK&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="33%">
<div class="Element68">
PMC_PCK2&nbsp;</div></td><td class="Element67" valign="top" width="16%">
<div class="Element68">
PA18&nbsp;</div></td><td class="Element67" valign="top" width="10%">
<div class="Element68">
24&nbsp;</div></td><td class="Element67" valign="top" width="40%">
<div class="Element68">
I2S MCLK (Master Clock)&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="33%">
<div class="Element68">
SSC_TD&nbsp;</div></td><td class="Element67" valign="top" width="16%">
<div class="Element68">
PD26&nbsp;</div></td><td class="Element67" valign="top" width="10%">
<div class="Element68">
53&nbsp;</div></td><td class="Element67" valign="top" width="40%">
<div class="Element68">
I2S Data&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="33%">
<div class="Element68">
SWITCH&nbsp;</div></td><td class="Element67" valign="top" width="16%">
<div class="Element68">
PA11&nbsp;</div></td><td class="Element67" valign="top" width="10%">
<div class="Element68">
66&nbsp;</div></td><td class="Element67" valign="top" width="40%">
<div class="Element68">
Push Button&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="33%">
<div class="Element68">
LED&nbsp;</div></td><td class="Element67" valign="top" width="16%">
<div class="Element68">
PA05&nbsp;</div></td><td class="Element67" valign="top" width="10%">
<div class="Element68">
73&nbsp;</div></td><td class="Element67" valign="top" width="40%">
<div class="Element68">
&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="33%">
<div class="Element68">
TWIHS0_TWCK0&nbsp;</div></td><td class="Element67" valign="top" width="16%">
<div class="Element68">
PA04&nbsp;</div></td><td class="Element67" valign="top" width="10%">
<div class="Element68">
77&nbsp;</div></td><td class="Element67" valign="top" width="40%">
<div class="Element68">
I2C&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="33%">
<div class="Element68">
TWIHS0_TWD0&nbsp;</div></td><td class="Element67" valign="top" width="16%">
<div class="Element68">
PA03&nbsp;</div></td><td class="Element67" valign="top" width="10%">
<div class="Element68">
91&nbsp;</div></td><td class="Element67" valign="top" width="40%">
<div class="Element68">
I2C&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="33%">
<div class="Element68">
STDBY&nbsp;</div></td><td class="Element67" valign="top" width="16%">
<div class="Element68">
PD11&nbsp;</div></td><td class="Element67" valign="top" width="10%">
<div class="Element68">
98&nbsp;</div></td><td class="Element67" valign="top" width="40%">
<div class="Element68">
&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="33%">
<div class="Element68">
LED2/VBUS DETECT(J204)&nbsp;</div></td><td class="Element67" valign="top" width="16%">
<div class="Element68">
PB08&nbsp;</div></td><td class="Element67" valign="top" width="10%">
<div class="Element68">
141&nbsp;</div></td><td class="Element67" valign="top" width="40%">
<div class="Element68">
J204 set to VBUS DETECT for USB Device&nbsp;</div></td></tr></table></div></div>
<p class="Element10">
When the I2SC1 is used the following pins are used: </p><div class="Element63">
<div class="TableDiv">
<table cellspacing="0" class="Table2">
<tr>
<td class="Element65" valign="top" width="26%">
<div class="Element66">
NAME&nbsp;</div></td><td class="Element65" valign="top" width="11%">
<div class="Element66">
PORT&nbsp;</div></td><td class="Element65" valign="top" width="6%">
<div class="Element66">
E70 PIN&nbsp;</div></td><td class="Element65" valign="top" width="57%">
<div class="Element66">
Notes&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="26%">
<div class="Element68">
I2SC1_WS&nbsp;</div></td><td class="Element67" valign="top" width="11%">
<div class="Element68">
PE00&nbsp;</div></td><td class="Element67" valign="top" width="6%">
<div class="Element68">
4&nbsp;</div></td><td class="Element67" valign="top" width="57%">
<div class="Element68">
I2S LRCK (Word Select)&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="26%">
<div class="Element68">
I2SC1_DO0&nbsp;</div></td><td class="Element67" valign="top" width="11%">
<div class="Element68">
PE01&nbsp;</div></td><td class="Element67" valign="top" width="6%">
<div class="Element68">
6&nbsp;</div></td><td class="Element67" valign="top" width="57%">
<div class="Element68">
I2S DO (Data Out)&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="26%">
<div class="Element68">
I2SC1_DI0&nbsp;</div></td><td class="Element67" valign="top" width="11%">
<div class="Element68">
PE02&nbsp;</div></td><td class="Element67" valign="top" width="6%">
<div class="Element68">
7&nbsp;</div></td><td class="Element67" valign="top" width="57%">
<div class="Element68">
I2S DI (Data In)&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="26%">
<div class="Element68">
I2SC1_CK&nbsp;</div></td><td class="Element67" valign="top" width="11%">
<div class="Element68">
PA20&nbsp;</div></td><td class="Element67" valign="top" width="6%">
<div class="Element68">
22&nbsp;</div></td><td class="Element67" valign="top" width="57%">
<div class="Element68">
I2S BCLK (Bit Clock)&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="26%">
<div class="Element68">
I2SC1_GCLK&nbsp;</div></td><td class="Element67" valign="top" width="11%">
<div class="Element68">
PA19&nbsp;</div></td><td class="Element67" valign="top" width="6%">
<div class="Element68">
23&nbsp;</div></td><td class="Element67" valign="top" width="57%">
<div class="Element68">
I2S MCLK (Bit Clock as used by the E70 I2SC1, I2S Master)&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="26%">
<div class="Element68">
PMC_PCK2&nbsp;</div></td><td class="Element67" valign="top" width="11%">
<div class="Element68">
PA18&nbsp;</div></td><td class="Element67" valign="top" width="6%">
<div class="Element68">
24&nbsp;</div></td><td class="Element67" valign="top" width="57%">
<div class="Element68">
I2S MCLK (Master Clock as used by the WM8904 Codec I2S Slave)&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="26%">
<div class="Element68">
SWITCH&nbsp;</div></td><td class="Element67" valign="top" width="11%">
<div class="Element68">
PA11&nbsp;</div></td><td class="Element67" valign="top" width="6%">
<div class="Element68">
66&nbsp;</div></td><td class="Element67" valign="top" width="57%">
<div class="Element68">
Push Button&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="26%">
<div class="Element68">
LED1&nbsp;</div></td><td class="Element67" valign="top" width="11%">
<div class="Element68">
PA05&nbsp;</div></td><td class="Element67" valign="top" width="6%">
<div class="Element68">
73&nbsp;</div></td><td class="Element67" valign="top" width="57%">
<div class="Element68">
&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="26%">
<div class="Element68">
TWIHS0_TWCK0&nbsp;</div></td><td class="Element67" valign="top" width="11%">
<div class="Element68">
PA04&nbsp;</div></td><td class="Element67" valign="top" width="6%">
<div class="Element68">
77&nbsp;</div></td><td class="Element67" valign="top" width="57%">
<div class="Element68">
I2C&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="26%">
<div class="Element68">
TWIHS0_TWD0&nbsp;</div></td><td class="Element67" valign="top" width="11%">
<div class="Element68">
PA03&nbsp;</div></td><td class="Element67" valign="top" width="6%">
<div class="Element68">
91&nbsp;</div></td><td class="Element67" valign="top" width="57%">
<div class="Element68">
I2C&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="26%">
<div class="Element68">
STDBY&nbsp;</div></td><td class="Element67" valign="top" width="11%">
<div class="Element68">
PD11&nbsp;</div></td><td class="Element67" valign="top" width="6%">
<div class="Element68">
98&nbsp;</div></td><td class="Element67" valign="top" width="57%">
<div class="Element68">
&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="26%">
<div class="Element68">
LED2/VBUS DETECT(J204)&nbsp;</div></td><td class="Element67" valign="top" width="11%">
<div class="Element68">
PB08&nbsp;</div></td><td class="Element67" valign="top" width="6%">
<div class="Element68">
141&nbsp;</div></td><td class="Element67" valign="top" width="57%">
<div class="Element68">
J204 set to VBUS DETECT for USB Device&nbsp;</div></td></tr></table></div></div>
<p class="Element10">
&nbsp;</p>
<div class="Element15">
Clock Manager</div>
<p class="Element10">
All clocks are generated from the 12 MHz Main Clock oscillator. From this clock is derived the following clocks: </p><div class="Element63">
<div class="TableDiv">
<table cellspacing="0" class="Table2">
<tr>
<td class="Element65" valign="top" width="18%">
<div class="Element66">
Clock&nbsp;</div></td><td class="Element65" valign="top" width="22%">
<div class="Element66">
Value&nbsp;</div></td><td class="Element65" valign="top" width="60%">
<div class="Element66">
Description&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="18%">
<div class="Element68">
HCLK&nbsp;</div></td><td class="Element67" valign="top" width="22%">
<div class="Element68">
300 MHz&nbsp;</div></td><td class="Element67" valign="top" width="60%">
<div class="Element68">
Processor Clock&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="18%">
<div class="Element68">
PCK2&nbsp;</div></td><td class="Element67" valign="top" width="22%">
<div class="Element68">
12 MHz&nbsp;</div></td><td class="Element67" valign="top" width="60%">
<div class="Element68">
Peripheral Clock 2&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="18%">
<div class="Element68">
USB FS&nbsp;</div></td><td class="Element67" valign="top" width="22%">
<div class="Element68">
48 MHz&nbsp;</div></td><td class="Element67" valign="top" width="60%">
<div class="Element68">
USB Full Speed Clock&nbsp;</div></td></tr></table></div></div>
<p class="Element10">
The I2S clocks are setup for 48KHz sampling rate, with stereo 16 bit samples, giving a 32 bit sample frame. The I2S clocks are generated from the WM8904 acting as I2S master using the 12.288 Mhz master clock obtained from Peripheral Clock 2 (PCK2). The I2S clocks will then be generated, as follows: </p><div class="Element63">
<div class="TableDiv">
<table cellspacing="0" class="Table2">
<tr>
<td class="Element65" valign="top" width="20%">
<div class="Element66">
I2S Function&nbsp;</div></td><td class="Element65" valign="top" width="33%">
<div class="Element66">
Value&nbsp;</div></td><td class="Element65" valign="top" width="47%">
<div class="Element66">
Description&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="20%">
<div class="Element68">
LRCK&nbsp;</div></td><td class="Element67" valign="top" width="33%">
<div class="Element68">
48.000000 K&nbsp;</div></td><td class="Element67" valign="top" width="47%">
<div class="Element68">
Sample rate clock&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="20%">
<div class="Element68">
BCLK&nbsp;</div></td><td class="Element67" valign="top" width="33%">
<div class="Element68">
3072000 Hz&nbsp;</div></td><td class="Element67" valign="top" width="47%">
<div class="Element68">
Bit Rate Clock&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="20%">
<div class="Element68">
MCLK&nbsp;</div></td><td class="Element67" valign="top" width="33%">
<div class="Element68">
12.288000 MHz&nbsp;</div></td><td class="Element67" valign="top" width="47%">
<div class="Element68">
Master Clock&nbsp;</div></td></tr></table></div></div>
<p class="Element10">
&nbsp;</p>
<div class="Element15">
MPLAB Harmony Configurator: Tools&gt;Clock Configuration</div>
<p class="Element10">
&nbsp;</p>
<p class="Element10">
<strong>SSC Clock Configuration</strong>&nbsp;</p>
<p class="Element10">
Uncheck the Main RC Oscillator and check the “Bypass” for the Main Crystal Oscillator. When the Bypass is checked, it will cause the Main Crystal Oscillator to become disabled. An external MEMS oscillator input on the XIN pin is used for Main Clock generation. </p><p class="Element10" style="text-align: center;">
<img src="APPS AUDIO usb_speaker clock diagram.png" border="0" alt="" title="">&nbsp;</p>
<p class="Element10" style="text-align: center;">
<i>Figure 4. Main Clock Configuration</i>&nbsp;</p><p class="Element10">
Enable the PCK2 output to enable the WM8904 master clock generation, to enable clocking for the SSC operating as a slave I2S: </p><p class="Element10" style="text-align: center;">
<img src="APPS AUDIO usb_speaker clock diagram2.png" border="0" alt="" title="">&nbsp;</p>
<p class="Element10" style="text-align: center;">
<i>Figure 5. Clock Diagram&gt;Peripheral Clock Enable</i></p><p class="Element10">
Enable the peripheral clock to the SSC using the Peripheral Clock Enable of the Peripheral Clock Controller: </p><p class="Element10" style="text-align: center;">
<img src="APPS AUDIO usb_speaker clock diagram3.png" border="0" alt="" title="">&nbsp;</p>
<p class="Element10" style="text-align: center;">
<i>Figure 6. Enable SSC Clock</i></p><p class="Element10">
<strong>I2SC1 Clock Configuration</strong>&nbsp;</p>
<p class="Element10">
The I2SC1 master requires the I2SC1_GCLK generate an MCLK to approximate 12.288Mhz. This is sourced using the PLLA Clock (PLLACK), as shown below. </p><p class="Element10" style="text-align: center;">
&nbsp;</p>
<p class="Element10" style="text-align: center;">
<img src="APPS AUDIO usb_speaker plla clock.png" border="0" alt="" title="">&nbsp;</p>
<p class="Element10" style="text-align: center;">
<i>Figure 7. PLLA Clock Generation for I2SC Peripheral</i>&nbsp;</p><p class="Element10">
&nbsp;</p>
<p class="Element10" style="text-align: center;">
<img src="APPS AUDIO usb_speaker GCLK2 clock.png" border="0" alt="" title="">&nbsp;</p>
<p class="Element10" style="text-align: center;">
<i>Figure 8. Generic Clock (GCLK) Generation for the I2SC1</i>&nbsp;</p>
<p class="Element10" style="text-align: center;">
&nbsp;</p>
<p class="Element10">
<strong>Harmony Code Generation</strong>&nbsp;</p>
<p class="Element10">
All the needed drivers, middleware, libraries and application framework code can be generated from the MHC blocks (MHC components) placed in the MHC Project Graph,&nbsp;</p>
<p class="Element10">
The generated framework code is placed under the firmware/src/config directory under the name of the configuration used for the Harmony 3 project. The initial application code is located in the firmware/src directory app.c and app.h files, which utilize the framework drivers, middleware and library APIs located in definitions.h located in the config directory.&nbsp;</p>
<p class="Element10">
All Harmony applications first execute the SYS_Initialize function, located in initialization.c. This is executed from the main function to initialize various subsystems such as the clock, ports, BSP (board support package), codec, usb, timers, and interrupts. The application APP_Initialize function in app.c is executed last in the generated SYS_Initialize routine after the system initializations have completed.&nbsp;</p>
<p class="Element10">
The SYS_Tasks function (located in tasks.c) is used to update the USB subsystems, WM8904 driver, timers etc., as well as the application state machine (APP_tasks routine in app.c). This function is executed from the main polling loop. The polling loop either execute SYS_Tasks repeatably in the infinite loop to perform the updates, or it the updates occur as separate processes executed at fixed time intervals using an RTOS schedular.&nbsp;</p>
<p class="Element10">
The application utilizes a simple state machine (APP_Tasks executed from SYS_Tasks) with the following functions</p>
<ol class="Element630">
<li value="1" class="Element600">Setup the drivers and USB Library interface</li>
<li value="2" class="Element600">Respond to USB Host control commands (“Attach”, “Detach”, “Suspend”)</li>
<li value="3" class="Element600">Initiate and maintains the bidirectional data audio streaming for the &quot;USB Playback&quot; function.</li>
<li value="4" class="Element600">Sense Volume control button pushes and set LED status lights</li>
</ol></div>
</div>
<a name="546F70696373"></a><div class="Element14">
Topics</div>
<div class="Element11">
<div class="Element10">
<div class="Element212">
<div class="TableDiv">
<table cellspacing="0" class="Table1">
<tr>
<td class="Element200" valign="top" width="35%">
<div class="Element201">
Name&nbsp;</div></td><td class="Element204" valign="top" width="65%">
<div class="Element205">
Description&nbsp;</div></td></tr><tr>
<td class="Element202" valign="top" width="35%">
<div class="Element203">
<a href="00144.html" target="topic">Building the Application</a>&nbsp;</div></td><td class="Element206" valign="top" width="65%">
<div class="Element207">
This section identifies the MPLAB X IDE project name and location and lists and describes the available configurations for the demonstration.&nbsp;</div></td></tr><tr>
<td class="Element202" valign="top" width="35%">
<div class="Element203">
<a href="00145.html" target="topic">Configuring the Hardware</a>&nbsp;</div></td><td class="Element206" valign="top" width="65%">
<div class="Element207">
This section describes how to configure the supported hardware.&nbsp;</div></td></tr><tr>
<td class="Element202" valign="top" width="35%">
<div class="Element203">
<a href="00150.html" target="topic">Running the Demonstration</a>&nbsp;</div></td><td class="Element206" valign="top" width="65%">
<div class="Element207">
This section demonstrates how to run the demonstration.&nbsp;</div></td></tr></table></div></div>
</div>
</div>
</div>
<!-- End Page Content -->

<!-- Begin Page Footer -->
<div class="Element95">
<a href="00152.html" target="topic">Audio Demonstrations</a> &gt; <a href="00129.html" target="topic">Demonstrations</a> &gt; <a href="00139.html" target="topic">usb_speaker</a></div>
<div class="Element93">
<table width="100%" cellspacing="0" cellpadding="0">
<tr><td width="25%">
<div class="Element3">
MPLAB Harmony Audio Help</div>
</td><td width="25%">
<div class="Element4">
<a href="contents.html" target="tocidx">Contents</a> | <a href="00158.html" target="topic">Home</a></div>
</td><td width="25%">
<div class="Element91">
<a href="00138.html" target="topic">Previous</a> | <a href="00129.html" target="topic">Up</a> | <a href="00144.html" target="topic">Next</a></div>
</td><td width="25%">
<div class="Element97">
<a href="mailto:docerrors@microchip.com&subject=MPLAB Harmony Documentation Feedback (Topic ID: APPS AUDIO usb_speaker Topic Title: usb_speaker)&body=Thank you for your feedback! Please include a description of your feedback, and indicate whether you are reporting an an error in the documentation or an enhancement.">Documentation Feedback</a><br> <a href="http://support.microchip.com" target="_blank">Microchip Support</a></div>
</td></tr></table></div>

<!-- End Page Footer -->
</div>
</div>

<!-- End Client Area -->
</body></html>